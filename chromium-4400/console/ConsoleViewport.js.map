{"version":3,"file":"ConsoleViewport.js","sourceRoot":"","sources":["../../../../../front_end/console/ConsoleViewport.js"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2013 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Components from '../components/components.js';\nimport * as Platform from '../platform/platform.js';\nimport * as UI from '../ui/ui.js';\n\nimport {ConsoleViewMessage} from './ConsoleViewMessage.js';  // eslint-disable-line no-unused-vars\n\nexport class ConsoleViewport {\n  /**\n   * @param {!ConsoleViewportProvider} provider\n   */\n  constructor(provider) {\n    this.element = /** @type {!HTMLElement} */ (document.createElement('div'));\n    this.element.style.overflow = 'auto';\n    this._topGapElement = this.element.createChild('div');\n    this._topGapElement.style.height = '0px';\n    this._topGapElement.style.color = 'transparent';\n    this._topGapElementActive = false;\n    this._contentElement = this.element.createChild('div');\n    this._bottomGapElement = this.element.createChild('div');\n    this._bottomGapElement.style.height = '0px';\n    this._bottomGapElement.style.color = 'transparent';\n    this._bottomGapElementActive = false;\n\n    // Text content needed for range intersection checks in _updateSelectionModel.\n    // Use Unicode ZERO WIDTH NO-BREAK SPACE, which avoids contributing any height to the element's layout overflow.\n    this._topGapElement.textContent = '\\uFEFF';\n    this._bottomGapElement.textContent = '\\uFEFF';\n\n    UI.ARIAUtils.markAsHidden(this._topGapElement);\n    UI.ARIAUtils.markAsHidden(this._bottomGapElement);\n\n    this._provider = provider;\n    this.element.addEventListener('scroll', this._onScroll.bind(this), false);\n    this.element.addEventListener('copy', /** @type {!EventListener} */ (this._onCopy.bind(this)), false);\n    this.element.addEventListener('dragstart', /** @type {function(!Event):*} */ (this._onDragStart.bind(this)), false);\n    this._contentElement.addEventListener('focusin', /** @type {!EventListener} */ (this._onFocusIn.bind(this)), false);\n    this._contentElement.addEventListener(\n        'focusout', /** @type {!EventListener} */ (this._onFocusOut.bind(this)), false);\n    this._contentElement.addEventListener('keydown', /** @type {!EventListener} */ (this._onKeyDown.bind(this)), false);\n    this._virtualSelectedIndex = -1;\n    this._contentElement.tabIndex = -1;\n\n    this._firstActiveIndex = -1;\n    this._lastActiveIndex = -1;\n    /** @type {!Array<!ConsoleViewportElement>} */\n    this._renderedItems = [];\n    /** @type {?{item: number, node: !Node, offset: number}} */\n    this._anchorSelection = null;\n    /** @type {?{item: number, node: !Node, offset: number}} */\n    this._headSelection = null;\n    this._itemCount = 0;\n    this._cumulativeHeights = new Int32Array(0);\n    this._muteCopyHandler = false;\n\n    // Listen for any changes to descendants and trigger a refresh. This ensures\n    // that items updated asynchronously will not break stick-to-bottom behavior\n    // if they change the scroll height.\n    this._observer = new MutationObserver(this.refresh.bind(this));\n    this._observerConfig = {childList: true, subtree: true};\n    this._stickToBottom = false;\n    this._selectionIsBackward = false;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  stickToBottom() {\n    return this._stickToBottom;\n  }\n\n  /**\n   * @param {boolean} value\n   */\n  setStickToBottom(value) {\n    this._stickToBottom = value;\n    if (this._stickToBottom) {\n      this._observer.observe(this._contentElement, this._observerConfig);\n    } else {\n      this._observer.disconnect();\n    }\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasVirtualSelection() {\n    return this._virtualSelectedIndex !== -1;\n  }\n\n  copyWithStyles() {\n    this._muteCopyHandler = true;\n    this.element.ownerDocument.execCommand('copy');\n    this._muteCopyHandler = false;\n  }\n\n  /**\n   * @param {!ClipboardEvent} event\n   */\n  _onCopy(event) {\n    if (this._muteCopyHandler) {\n      return;\n    }\n\n    const text = this._selectedText();\n    if (!text) {\n      return;\n    }\n\n    event.preventDefault();\n\n    if (this._selectionContainsTable()) {\n      this.copyWithStyles();\n    } else if (event.clipboardData) {\n      event.clipboardData.setData('text/plain', text);\n    }\n  }\n\n  /**\n   * @param {!FocusEvent} event\n   */\n  _onFocusIn(event) {\n    const renderedIndex =\n        this._renderedItems.findIndex(item => item.element().isSelfOrAncestor(/** @type {?Node} */ (event.target)));\n    if (renderedIndex !== -1) {\n      this._virtualSelectedIndex = this._firstActiveIndex + renderedIndex;\n    }\n    let focusLastChild = false;\n    // Make default selection when moving from external (e.g. prompt) to the container.\n    if (this._virtualSelectedIndex === -1 && this._isOutsideViewport(/** @type {?Element} */ (event.relatedTarget)) &&\n        event.target === this._contentElement && this._itemCount) {\n      focusLastChild = true;\n      this._virtualSelectedIndex = this._itemCount - 1;\n\n      // Update stick to bottom before scrolling into view.\n      this.refresh();\n      this.scrollItemIntoView(this._virtualSelectedIndex);\n    }\n    this._updateFocusedItem(focusLastChild);\n  }\n\n  /**\n   * @param {!FocusEvent} event\n   */\n  _onFocusOut(event) {\n    // Remove selection when focus moves to external location (e.g. prompt).\n    if (this._isOutsideViewport(/** @type {?Element} */ (event.relatedTarget))) {\n      this._virtualSelectedIndex = -1;\n    }\n    this._updateFocusedItem();\n  }\n\n  /**\n   * @param {?Element} element\n   * @return {boolean}\n   */\n  _isOutsideViewport(element) {\n    return element !== null && !element.isSelfOrDescendant(this._contentElement);\n  }\n\n  /**\n   * @param {!DragEvent} event\n   */\n  _onDragStart(event) {\n    const text = this._selectedText();\n    if (!text) {\n      return false;\n    }\n    if (event.dataTransfer) {\n      event.dataTransfer.clearData();\n      event.dataTransfer.setData('text/plain', text);\n      event.dataTransfer.effectAllowed = 'copy';\n    }\n    return true;\n  }\n\n  /**\n   * @param {!KeyboardEvent} event\n   */\n  _onKeyDown(event) {\n    if (UI.UIUtils.isEditing() || !this._itemCount || event.shiftKey) {\n      return;\n    }\n    let isArrowUp = false;\n    switch (event.key) {\n      case 'ArrowUp':\n        if (this._virtualSelectedIndex > 0) {\n          isArrowUp = true;\n          this._virtualSelectedIndex--;\n        } else {\n          return;\n        }\n        break;\n      case 'ArrowDown':\n        if (this._virtualSelectedIndex < this._itemCount - 1) {\n          this._virtualSelectedIndex++;\n        } else {\n          return;\n        }\n        break;\n      case 'Home':\n        this._virtualSelectedIndex = 0;\n        break;\n      case 'End':\n        this._virtualSelectedIndex = this._itemCount - 1;\n        break;\n      default:\n        return;\n    }\n    event.consume(true);\n    this.scrollItemIntoView(this._virtualSelectedIndex);\n    this._updateFocusedItem(isArrowUp);\n  }\n\n  /**\n   * @param {boolean=} focusLastChild\n   */\n  _updateFocusedItem(focusLastChild) {\n    const selectedElement = this.renderedElementAt(this._virtualSelectedIndex);\n    const changed = this._lastSelectedElement !== selectedElement;\n    const containerHasFocus = this._contentElement === this.element.ownerDocument.deepActiveElement();\n    if (this._lastSelectedElement && changed) {\n      this._lastSelectedElement.classList.remove('console-selected');\n    }\n    if (selectedElement && (focusLastChild || changed || containerHasFocus) && this.element.hasFocus()) {\n      selectedElement.classList.add('console-selected');\n      // Do not focus the message if something within holds focus (e.g. object).\n      if (focusLastChild) {\n        this.setStickToBottom(false);\n        this._renderedItems[this._virtualSelectedIndex - this._firstActiveIndex].focusLastChildOrSelf();\n      } else if (!selectedElement.hasFocus()) {\n        selectedElement.focus({preventScroll: true});\n      }\n    }\n    if (this._itemCount && !this._contentElement.hasFocus()) {\n      this._contentElement.tabIndex = 0;\n    } else {\n      this._contentElement.tabIndex = -1;\n    }\n    this._lastSelectedElement = selectedElement;\n  }\n\n  /**\n   * @return {!Element}\n   */\n  contentElement() {\n    return this._contentElement;\n  }\n\n  invalidate() {\n    delete this._cachedProviderElements;\n    this._itemCount = this._provider.itemCount();\n    if (this._virtualSelectedIndex > this._itemCount - 1) {\n      this._virtualSelectedIndex = this._itemCount - 1;\n    }\n    this._rebuildCumulativeHeights();\n    this.refresh();\n  }\n\n  /**\n   * @param {number} index\n   * @return {?ConsoleViewportElement}\n   */\n  _providerElement(index) {\n    if (!this._cachedProviderElements) {\n      this._cachedProviderElements = new Array(this._itemCount);\n    }\n    let element = this._cachedProviderElements[index];\n    if (!element) {\n      element = this._provider.itemElement(index);\n      this._cachedProviderElements[index] = element;\n    }\n    return element;\n  }\n\n  _rebuildCumulativeHeights() {\n    const firstActiveIndex = this._firstActiveIndex;\n    const lastActiveIndex = this._lastActiveIndex;\n    let height = 0;\n    this._cumulativeHeights = new Int32Array(this._itemCount);\n    for (let i = 0; i < this._itemCount; ++i) {\n      if (firstActiveIndex <= i && i - firstActiveIndex < this._renderedItems.length && i <= lastActiveIndex) {\n        height += this._renderedItems[i - firstActiveIndex].element().offsetHeight;\n      } else {\n        height += this._provider.fastHeight(i);\n      }\n      this._cumulativeHeights[i] = height;\n    }\n  }\n\n  _rebuildCumulativeHeightsIfNeeded() {\n    let totalCachedHeight = 0;\n    let totalMeasuredHeight = 0;\n    // Check whether current items in DOM have changed heights. Tolerate 1-pixel\n    // error due to double-to-integer rounding errors.\n    for (let i = 0; i < this._renderedItems.length; ++i) {\n      const cachedItemHeight = this._cachedItemHeight(this._firstActiveIndex + i);\n      const measuredHeight = this._renderedItems[i].element().offsetHeight;\n      if (Math.abs(cachedItemHeight - measuredHeight) > 1) {\n        this._rebuildCumulativeHeights();\n        return;\n      }\n      totalMeasuredHeight += measuredHeight;\n      totalCachedHeight += cachedItemHeight;\n      if (Math.abs(totalCachedHeight - totalMeasuredHeight) > 1) {\n        this._rebuildCumulativeHeights();\n        return;\n      }\n    }\n  }\n\n  /**\n   * @param {number} index\n   * @return {number}\n   */\n  _cachedItemHeight(index) {\n    return index === 0 ? this._cumulativeHeights[0] :\n                         this._cumulativeHeights[index] - this._cumulativeHeights[index - 1];\n  }\n\n  /**\n   * @param {?Selection} selection\n   */\n  _isSelectionBackwards(selection) {\n    if (!selection || !selection.rangeCount || !selection.anchorNode || !selection.focusNode) {\n      return false;\n    }\n    const range = document.createRange();\n    range.setStart(selection.anchorNode, selection.anchorOffset);\n    range.setEnd(selection.focusNode, selection.focusOffset);\n    return range.collapsed;\n  }\n\n  /**\n   * @param {number} itemIndex\n   * @param {!Node} node\n   * @param {number} offset\n   * @return {!{item: number, node: !Node, offset: number}}\n   */\n  _createSelectionModel(itemIndex, node, offset) {\n    return {item: itemIndex, node: node, offset: offset};\n  }\n\n  /**\n   * @param {?Selection} selection\n   */\n  _updateSelectionModel(selection) {\n    const range = selection && selection.rangeCount ? selection.getRangeAt(0) : null;\n    if (!range || (!selection || selection.isCollapsed) || !this.element.hasSelection()) {\n      this._headSelection = null;\n      this._anchorSelection = null;\n      return false;\n    }\n\n    let firstSelectedIndex = Number.MAX_VALUE;\n    let lastSelectedIndex = -1;\n\n    let hasVisibleSelection = false;\n    for (let i = 0; i < this._renderedItems.length; ++i) {\n      if (range.intersectsNode(this._renderedItems[i].element())) {\n        const index = i + this._firstActiveIndex;\n        firstSelectedIndex = Math.min(firstSelectedIndex, index);\n        lastSelectedIndex = Math.max(lastSelectedIndex, index);\n        hasVisibleSelection = true;\n      }\n    }\n    const topOverlap = range.intersectsNode(this._topGapElement) && this._topGapElementActive;\n    const bottomOverlap = range.intersectsNode(this._bottomGapElement) && this._bottomGapElementActive;\n    if (!topOverlap && !bottomOverlap && !hasVisibleSelection) {\n      this._headSelection = null;\n      this._anchorSelection = null;\n      return false;\n    }\n\n    if (!this._anchorSelection || !this._headSelection) {\n      this._anchorSelection = this._createSelectionModel(0, this.element, 0);\n      this._headSelection = this._createSelectionModel(this._itemCount - 1, this.element, this.element.children.length);\n      this._selectionIsBackward = false;\n    }\n\n    const isBackward = this._isSelectionBackwards(selection);\n    const startSelection = this._selectionIsBackward ? this._headSelection : this._anchorSelection;\n    const endSelection = this._selectionIsBackward ? this._anchorSelection : this._headSelection;\n    let firstSelected = null;\n    let lastSelected = null;\n    if (hasVisibleSelection) {\n      firstSelected = this._createSelectionModel(\n          firstSelectedIndex, /** @type {!Node} */ (range.startContainer), range.startOffset);\n      lastSelected =\n          this._createSelectionModel(lastSelectedIndex, /** @type {!Node} */ (range.endContainer), range.endOffset);\n    }\n    if (topOverlap && bottomOverlap && hasVisibleSelection) {\n      firstSelected = (firstSelected && firstSelected.item < startSelection.item) ? firstSelected : startSelection;\n      lastSelected = (lastSelected && lastSelected.item > endSelection.item) ? lastSelected : endSelection;\n    } else if (!hasVisibleSelection) {\n      firstSelected = startSelection;\n      lastSelected = endSelection;\n    } else if (topOverlap) {\n      firstSelected = isBackward ? this._headSelection : this._anchorSelection;\n    } else if (bottomOverlap) {\n      lastSelected = isBackward ? this._anchorSelection : this._headSelection;\n    }\n\n    if (isBackward) {\n      this._anchorSelection = lastSelected;\n      this._headSelection = firstSelected;\n    } else {\n      this._anchorSelection = firstSelected;\n      this._headSelection = lastSelected;\n    }\n    this._selectionIsBackward = isBackward;\n    return true;\n  }\n\n  /**\n   * @param {?Selection} selection\n   */\n  _restoreSelection(selection) {\n    if (!selection || !this._anchorSelection || !this._headSelection) {\n      return;\n    }\n\n    /**\n     * @param {!{item: number, node: !Node, offset: number}} selection\n     * @param {boolean} isSelectionBackwards\n     * @return {!{element: !Node, offset: number}}\n     */\n    const clampSelection = (selection, isSelectionBackwards) => {\n      if (this._firstActiveIndex <= selection.item && selection.item <= this._lastActiveIndex) {\n        return {element: selection.node, offset: selection.offset};\n      }\n\n      const element = selection.item < this._firstActiveIndex ? this._topGapElement : this._bottomGapElement;\n      return {element, offset: isSelectionBackwards ? 1 : 0};\n    };\n\n    const {element: anchorElement, offset: anchorOffset} =\n        clampSelection(this._anchorSelection, Boolean(this._selectionIsBackward));\n    const {element: headElement, offset: headOffset} = clampSelection(this._headSelection, !this._selectionIsBackward);\n    selection.setBaseAndExtent(anchorElement, anchorOffset, headElement, headOffset);\n  }\n\n  _selectionContainsTable() {\n    if (!this._anchorSelection || !this._headSelection) {\n      return false;\n    }\n\n    const start = this._selectionIsBackward ? this._headSelection.item : this._anchorSelection.item;\n    const end = this._selectionIsBackward ? this._anchorSelection.item : this._headSelection.item;\n\n    for (let i = start; i <= end; i++) {\n      const element = /** @type {!ConsoleViewMessage} */ (this._providerElement(i));\n      if (element && element.consoleMessage().type === 'table') {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  refresh() {\n    this._observer.disconnect();\n    this._innerRefresh();\n    if (this._stickToBottom) {\n      this._observer.observe(this._contentElement, this._observerConfig);\n    }\n  }\n\n  _innerRefresh() {\n    if (!this._visibleHeight()) {\n      return;\n    }  // Do nothing for invisible controls.\n\n    if (!this._itemCount) {\n      for (let i = 0; i < this._renderedItems.length; ++i) {\n        this._renderedItems[i].willHide();\n      }\n      this._renderedItems = [];\n      this._contentElement.removeChildren();\n      this._topGapElement.style.height = '0px';\n      this._bottomGapElement.style.height = '0px';\n      this._firstActiveIndex = -1;\n      this._lastActiveIndex = -1;\n      this._updateFocusedItem();\n      return;\n    }\n\n    const selection = this.element.getComponentSelection();\n    const shouldRestoreSelection = this._updateSelectionModel(selection);\n\n    const visibleFrom = this.element.scrollTop;\n    const visibleHeight = this._visibleHeight();\n    const activeHeight = visibleHeight * 2;\n    this._rebuildCumulativeHeightsIfNeeded();\n\n    // When the viewport is scrolled to the bottom, using the cumulative heights estimate is not\n    // precise enough to determine next visible indices. This stickToBottom check avoids extra\n    // calls to refresh in those cases.\n    if (this._stickToBottom) {\n      this._firstActiveIndex =\n          Math.max(this._itemCount - Math.ceil(activeHeight / this._provider.minimumRowHeight()), 0);\n      this._lastActiveIndex = this._itemCount - 1;\n    } else {\n      this._firstActiveIndex = Math.max(\n          Platform.ArrayUtilities.lowerBound(\n              this._cumulativeHeights, visibleFrom + 1 - (activeHeight - visibleHeight) / 2,\n              Platform.ArrayUtilities.DEFAULT_COMPARATOR),\n          0);\n      // Proactively render more rows in case some of them will be collapsed without triggering refresh. @see crbug.com/390169\n      this._lastActiveIndex = this._firstActiveIndex + Math.ceil(activeHeight / this._provider.minimumRowHeight()) - 1;\n      this._lastActiveIndex = Math.min(this._lastActiveIndex, this._itemCount - 1);\n    }\n\n    const topGapHeight = this._cumulativeHeights[this._firstActiveIndex - 1] || 0;\n    const bottomGapHeight =\n        this._cumulativeHeights[this._cumulativeHeights.length - 1] - this._cumulativeHeights[this._lastActiveIndex];\n\n    /**\n     * @this {ConsoleViewport}\n     */\n    function prepare() {\n      this._topGapElement.style.height = topGapHeight + 'px';\n      this._bottomGapElement.style.height = bottomGapHeight + 'px';\n      this._topGapElementActive = Boolean(topGapHeight);\n      this._bottomGapElementActive = Boolean(bottomGapHeight);\n      this._contentElement.style.setProperty('height', '10000000px');\n    }\n\n    this._partialViewportUpdate(prepare.bind(this));\n    this._contentElement.style.removeProperty('height');\n    // Should be the last call in the method as it might force layout.\n    if (shouldRestoreSelection) {\n      this._restoreSelection(selection);\n    }\n    if (this._stickToBottom) {\n      this.element.scrollTop = 10000000;\n    }\n  }\n\n  /**\n   * @param {function():void} prepare\n   */\n  _partialViewportUpdate(prepare) {\n    /** @type {!Set<!ConsoleViewportElement>} */\n    const itemsToRender = new Set();\n    for (let i = this._firstActiveIndex; i <= this._lastActiveIndex; ++i) {\n      const providerElement = this._providerElement(i);\n      console.assert(Boolean(providerElement), 'Expected provider element to be defined');\n      if (providerElement) {\n        itemsToRender.add(providerElement);\n      }\n    }\n    const willBeHidden = this._renderedItems.filter(item => !itemsToRender.has(item));\n    for (let i = 0; i < willBeHidden.length; ++i) {\n      willBeHidden[i].willHide();\n    }\n    prepare();\n    let hadFocus = false;\n    for (let i = 0; i < willBeHidden.length; ++i) {\n      hadFocus = hadFocus || willBeHidden[i].element().hasFocus();\n      willBeHidden[i].element().remove();\n    }\n\n    const wasShown = [];\n    let anchor = this._contentElement.firstChild;\n    for (const viewportElement of itemsToRender) {\n      const element = viewportElement.element();\n      if (element !== anchor) {\n        const shouldCallWasShown = !element.parentElement;\n        if (shouldCallWasShown) {\n          wasShown.push(viewportElement);\n        }\n        this._contentElement.insertBefore(element, anchor);\n      } else {\n        anchor = anchor.nextSibling;\n      }\n    }\n    for (let i = 0; i < wasShown.length; ++i) {\n      wasShown[i].wasShown();\n    }\n    this._renderedItems = Array.from(itemsToRender);\n\n    if (hadFocus) {\n      this._contentElement.focus();\n    }\n    this._updateFocusedItem();\n  }\n\n  /**\n   * @return {?string}\n   */\n  _selectedText() {\n    this._updateSelectionModel(this.element.getComponentSelection());\n    if (!this._headSelection || !this._anchorSelection) {\n      return null;\n    }\n\n    let startSelection = null;\n    let endSelection = null;\n    if (this._selectionIsBackward) {\n      startSelection = this._headSelection;\n      endSelection = this._anchorSelection;\n    } else {\n      startSelection = this._anchorSelection;\n      endSelection = this._headSelection;\n    }\n\n    const textLines = [];\n    for (let i = startSelection.item; i <= endSelection.item; ++i) {\n      const providerElement = this._providerElement(i);\n      console.assert(Boolean(providerElement));\n      if (!providerElement) {\n        continue;\n      }\n      const element = providerElement.element();\n      const lineContent = element.childTextNodes().map(Components.Linkifier.Linkifier.untruncatedNodeText).join('');\n      textLines.push(lineContent);\n    }\n\n    const endProviderElement = this._providerElement(endSelection.item);\n    const endSelectionElement = endProviderElement && endProviderElement.element();\n    if (endSelectionElement && endSelection.node && endSelection.node.isSelfOrDescendant(endSelectionElement)) {\n      const itemTextOffset = this._textOffsetInNode(endSelectionElement, endSelection.node, endSelection.offset);\n      if (textLines.length > 0) {\n        textLines[textLines.length - 1] = textLines[textLines.length - 1].substring(0, itemTextOffset);\n      }\n    }\n\n    const startProviderElement = this._providerElement(startSelection.item);\n    const startSelectionElement = startProviderElement && startProviderElement.element();\n    if (startSelectionElement && startSelection.node && startSelection.node.isSelfOrDescendant(startSelectionElement)) {\n      const itemTextOffset = this._textOffsetInNode(startSelectionElement, startSelection.node, startSelection.offset);\n      textLines[0] = textLines[0].substring(itemTextOffset);\n    }\n\n    return textLines.join('\\n');\n  }\n\n  /**\n   * @param {!Element} itemElement\n   * @param {!Node} selectionNode\n   * @param {number} offset\n   * @return {number}\n   */\n  _textOffsetInNode(itemElement, selectionNode, offset) {\n    // If the selectionNode is not a TextNode, we may need to convert a child offset into a character offset.\n    const textContentLength = selectionNode.textContent ? selectionNode.textContent.length : 0;\n    if (selectionNode.nodeType !== Node.TEXT_NODE) {\n      if (offset < selectionNode.childNodes.length) {\n        selectionNode = /** @type {!Node} */ (selectionNode.childNodes.item(offset));\n        offset = 0;\n      } else {\n        offset = textContentLength;\n      }\n    }\n\n    let chars = 0;\n    /** @type {?Node} */\n    let node = itemElement;\n    while ((node = node.traverseNextNode(itemElement)) && node !== selectionNode) {\n      if (node.nodeType !== Node.TEXT_NODE ||\n          (node.parentElement &&\n           (node.parentElement.nodeName === 'STYLE' || node.parentElement.nodeName === 'SCRIPT'))) {\n        continue;\n      }\n      chars += Components.Linkifier.Linkifier.untruncatedNodeText(node).length;\n    }\n    // If the selected node text was truncated, treat any non-zero offset as the full length.\n    const untruncatedContainerLength = Components.Linkifier.Linkifier.untruncatedNodeText(selectionNode).length;\n    if (offset > 0 && untruncatedContainerLength !== textContentLength) {\n      offset = untruncatedContainerLength;\n    }\n    return chars + offset;\n  }\n\n  /**\n   * @param {!Event} event\n   */\n  _onScroll(event) {\n    this.refresh();\n  }\n\n  /**\n   * @return {number}\n   */\n  firstVisibleIndex() {\n    if (!this._cumulativeHeights.length) {\n      return -1;\n    }\n    this._rebuildCumulativeHeightsIfNeeded();\n    return Platform.ArrayUtilities.lowerBound(\n        this._cumulativeHeights, this.element.scrollTop + 1, Platform.ArrayUtilities.DEFAULT_COMPARATOR);\n  }\n\n  /**\n   * @return {number}\n   */\n  lastVisibleIndex() {\n    if (!this._cumulativeHeights.length) {\n      return -1;\n    }\n    this._rebuildCumulativeHeightsIfNeeded();\n    const scrollBottom = this.element.scrollTop + this.element.clientHeight;\n    const right = this._itemCount - 1;\n    return Platform.ArrayUtilities.lowerBound(\n        this._cumulativeHeights, scrollBottom, Platform.ArrayUtilities.DEFAULT_COMPARATOR, undefined, right);\n  }\n\n  /**\n   * @param {number} index\n   * @return {?HTMLElement}\n   */\n  renderedElementAt(index) {\n    if (index === -1 || index < this._firstActiveIndex || index > this._lastActiveIndex) {\n      return null;\n    }\n    return this._renderedItems[index - this._firstActiveIndex].element();\n  }\n\n  /**\n   * @param {number} index\n   * @param {boolean=} makeLast\n   */\n  scrollItemIntoView(index, makeLast) {\n    const firstVisibleIndex = this.firstVisibleIndex();\n    const lastVisibleIndex = this.lastVisibleIndex();\n    if (index > firstVisibleIndex && index < lastVisibleIndex) {\n      return;\n    }\n    // If the prompt is visible, then the last item must be fully on screen.\n    if (index === lastVisibleIndex &&\n        this._cumulativeHeights[index] <= this.element.scrollTop + this._visibleHeight()) {\n      return;\n    }\n    if (makeLast) {\n      this.forceScrollItemToBeLast(index);\n    } else if (index <= firstVisibleIndex) {\n      this.forceScrollItemToBeFirst(index);\n    } else if (index >= lastVisibleIndex) {\n      this.forceScrollItemToBeLast(index);\n    }\n  }\n\n  /**\n   * @param {number} index\n   */\n  forceScrollItemToBeFirst(index) {\n    console.assert(index >= 0 && index < this._itemCount, 'Cannot scroll item at invalid index');\n    this.setStickToBottom(false);\n    this._rebuildCumulativeHeightsIfNeeded();\n    this.element.scrollTop = index > 0 ? this._cumulativeHeights[index - 1] : 0;\n    if (UI.UIUtils.isScrolledToBottom(this.element)) {\n      this.setStickToBottom(true);\n    }\n    this.refresh();\n    // After refresh, the item is in DOM, but may not be visible (items above were larger than expected).\n    const renderedElement = this.renderedElementAt(index);\n    if (renderedElement) {\n      renderedElement.scrollIntoView(true /* alignTop */);\n    }\n  }\n\n  /**\n   * @param {number} index\n   */\n  forceScrollItemToBeLast(index) {\n    console.assert(index >= 0 && index < this._itemCount, 'Cannot scroll item at invalid index');\n    this.setStickToBottom(false);\n    this._rebuildCumulativeHeightsIfNeeded();\n    this.element.scrollTop = this._cumulativeHeights[index] - this._visibleHeight();\n    if (UI.UIUtils.isScrolledToBottom(this.element)) {\n      this.setStickToBottom(true);\n    }\n    this.refresh();\n    // After refresh, the item is in DOM, but may not be visible (items above were larger than expected).\n    const renderedElement = this.renderedElementAt(index);\n    if (renderedElement) {\n      renderedElement.scrollIntoView(false /* alignTop */);\n    }\n  }\n\n  /**\n   * @return {number}\n   */\n  _visibleHeight() {\n    // Use offsetHeight instead of clientHeight to avoid being affected by horizontal scroll.\n    return this.element.offsetHeight;\n  }\n}\n\n/**\n * @interface\n */\nexport class ConsoleViewportProvider {\n  /**\n   * @param {number} index\n   * @return {number}\n   */\n  fastHeight(index) {\n    return 0;\n  }\n\n  /**\n   * @return {number}\n   */\n  itemCount() {\n    return 0;\n  }\n\n  /**\n   * @return {number}\n   */\n  minimumRowHeight() {\n    return 0;\n  }\n\n  /**\n   * @param {number} index\n   * @return {?ConsoleViewportElement}\n   */\n  itemElement(index) {\n    return null;\n  }\n}\n\n/**\n * @interface\n */\nexport class ConsoleViewportElement {\n  willHide() {\n  }\n\n  wasShown() {\n  }\n\n  /**\n   * @return {!HTMLElement}\n   */\n  element() {\n    throw new Error('Unimplemented method');\n  }\n\n  focusLastChildOrSelf() {\n  }\n}\n"]}