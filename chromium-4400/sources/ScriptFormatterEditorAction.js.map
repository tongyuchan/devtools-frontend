{"version":3,"file":"ScriptFormatterEditorAction.js","sourceRoot":"","sources":["../../../../../front_end/sources/ScriptFormatterEditorAction.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport * as FormatterModule from '../formatter/formatter.js';\nimport * as Persistence from '../persistence/persistence.js';\nimport * as SourceFrame from '../source_frame/source_frame.js';\nimport * as UI from '../ui/ui.js';\nimport * as Workspace from '../workspace/workspace.js';\n\nimport {EditorAction, Events, SourcesView} from './SourcesView.js';  // eslint-disable-line no-unused-vars\n\n/**\n * @implements {EditorAction}\n */\nexport class ScriptFormatterEditorAction {\n  constructor() {\n    /** @type {!Set<string>} */\n    this._pathsToFormatOnLoad = new Set();\n\n    /** @type {!SourcesView} */\n    this._sourcesView;\n    /** @type {!UI.Toolbar.ToolbarButton} */\n    this._button;\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _editorSelected(event) {\n    const uiSourceCode = /** @type {!Workspace.UISourceCode.UISourceCode} */ (event.data);\n    this._updateButton(uiSourceCode);\n\n    if (this._isFormatableScript(uiSourceCode) && this._pathsToFormatOnLoad.has(uiSourceCode.url()) &&\n        !FormatterModule.SourceFormatter.SourceFormatter.instance().hasFormatted(uiSourceCode)) {\n      this._showFormatted(uiSourceCode);\n    }\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  async _editorClosed(event) {\n    const uiSourceCode = /** @type {!Workspace.UISourceCode.UISourceCode} */ (event.data.uiSourceCode);\n    const wasSelected = /** @type {boolean} */ (event.data.wasSelected);\n\n    if (wasSelected) {\n      this._updateButton(null);\n    }\n    const original =\n        await FormatterModule.SourceFormatter.SourceFormatter.instance().discardFormattedUISourceCode(uiSourceCode);\n    if (original) {\n      this._pathsToFormatOnLoad.delete(original.url());\n    }\n  }\n\n  /**\n   * @param {?Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  _updateButton(uiSourceCode) {\n    const isFormattable = this._isFormatableScript(uiSourceCode);\n    this._button.element.classList.toggle('hidden', !isFormattable);\n    if (uiSourceCode) {\n      // We always update the title of the button, even if the {uiSourceCode} is\n      // not formattable, since we use the title (the aria-label actually) as a\n      // signal for the E2E tests that the source code loading is done.\n      this._button.setTitle(Common.UIString.UIString(`Pretty print ${uiSourceCode.name()}`));\n    }\n  }\n\n  /**\n   * @override\n   * @param {!SourcesView} sourcesView\n   * @return {!UI.Toolbar.ToolbarButton}\n   */\n  button(sourcesView) {\n    if (this._button) {\n      return this._button;\n    }\n\n    this._sourcesView = sourcesView;\n    this._sourcesView.addEventListener(Events.EditorSelected, event => {\n      this._editorSelected(event);\n    });\n    this._sourcesView.addEventListener(Events.EditorClosed, event => {\n      this._editorClosed(event);\n    });\n\n    this._button = new UI.Toolbar.ToolbarButton(Common.UIString.UIString('Pretty print'), 'largeicon-pretty-print');\n    this._button.addEventListener(UI.Toolbar.ToolbarButton.Events.Click, this._onFormatScriptButtonClicked, this);\n    this._updateButton(sourcesView.currentUISourceCode());\n\n    return this._button;\n  }\n\n  /**\n   * @param {?Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {boolean}\n   */\n  _isFormatableScript(uiSourceCode) {\n    if (!uiSourceCode) {\n      return false;\n    }\n    if (uiSourceCode.project().canSetFileContent()) {\n      return false;\n    }\n    if (uiSourceCode.project().type() === Workspace.Workspace.projectTypes.Formatter) {\n      return false;\n    }\n    if (Persistence.Persistence.PersistenceImpl.instance().binding(uiSourceCode)) {\n      return false;\n    }\n    if (uiSourceCode.mimeType() === 'application/wasm') {\n      return false;\n    }\n    return uiSourceCode.contentType().hasScripts();\n  }\n\n  isCurrentUISourceCodeFormatable() {\n    const uiSourceCode = this._sourcesView.currentUISourceCode();\n    return this._isFormatableScript(uiSourceCode);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _onFormatScriptButtonClicked(event) {\n    this.toggleFormatScriptSource();\n  }\n\n  toggleFormatScriptSource() {\n    const uiSourceCode = this._sourcesView.currentUISourceCode();\n    if (!uiSourceCode || !this._isFormatableScript(uiSourceCode)) {\n      return;\n    }\n    this._pathsToFormatOnLoad.add(uiSourceCode.url());\n    this._showFormatted(uiSourceCode);\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  async _showFormatted(uiSourceCode) {\n    const formatData = await FormatterModule.SourceFormatter.SourceFormatter.instance().format(uiSourceCode);\n    if (uiSourceCode !== this._sourcesView.currentUISourceCode()) {\n      return;\n    }\n    const sourceFrame = this._sourcesView.viewForFile(uiSourceCode);\n    let start = [0, 0];\n    if (sourceFrame instanceof SourceFrame.SourceFrame.SourceFrameImpl) {\n      const selection = sourceFrame.selection();\n      start = formatData.mapping.originalToFormatted(selection.startLine, selection.startColumn);\n    }\n    this._sourcesView.showSourceLocation(formatData.formattedSourceCode, start[0], start[1]);\n  }\n}\n"]}