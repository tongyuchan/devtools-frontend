{"version":3,"file":"RequestInitiatorView.js","sourceRoot":"","sources":["../../../../../front_end/network/RequestInitiatorView.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport * as Components from '../components/components.js';\nimport {ls} from '../platform/platform.js';\nimport * as SDK from '../sdk/sdk.js';\nimport * as UI from '../ui/ui.js';\n\nexport class RequestInitiatorView extends UI.Widget.VBox {\n  /**\n   * @param {!SDK.NetworkRequest.NetworkRequest} request\n   */\n  constructor(request) {\n    super();\n    this.registerRequiredCSS('network/requestInitiatorView.css', {enableLegacyPatching: false});\n    this.element.classList.add('request-initiator-view');\n    /** @type {!Components.Linkifier.Linkifier} */\n    this._linkifier = new Components.Linkifier.Linkifier();\n    this._request = request;\n    this._emptyWidget = new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString('This request has no initiator data.'));\n    this._emptyWidget.show(this.element);\n    this._hasShown = false;\n  }\n\n  /**\n   * @param {!SDK.NetworkRequest.NetworkRequest} request\n   * @param {!Components.Linkifier.Linkifier} linkifier\n   * @param {boolean=} focusableLink\n   * @param {function()=} callback\n   * @return {?{element: !Element, links: !Array<!Element>}}\n   */\n  static createStackTracePreview(request, linkifier, focusableLink, callback) {\n    const initiator = request.initiator();\n    if (!initiator || !initiator.stack) {\n      return null;\n    }\n    const networkManager = SDK.NetworkManager.NetworkManager.forRequest(request);\n    const target = networkManager ? networkManager.target() : null;\n    const stackTrace = Components.JSPresentationUtils.buildStackTracePreviewContents(\n        target, linkifier, {stackTrace: initiator.stack, contentUpdated: callback, tabStops: focusableLink});\n    return stackTrace;\n  }\n\n  /**\n   * @param {!Element} sectionContent\n   * @param {string} title\n   * @param {boolean} expanded\n   */\n  _appendExpandableSection(sectionContent, title, expanded) {\n    const section = document.createElement('div');\n    section.classList.add('request-initiator-view-section');\n    const icon = UI.Icon.Icon.create('smallicon-triangle-right');\n    const clickableElement = section.createChild('div', 'request-initiator-view-section-title');\n    clickableElement.appendChild(icon);\n    UI.UIUtils.createTextChild(clickableElement, title);\n    clickableElement.tabIndex = 0;\n    sectionContent.classList.add('hidden', 'request-initiator-view-section-content');\n    section.appendChild(sectionContent);\n\n    /** @param {boolean} expanded */\n    const expand = expanded => {\n      icon.setIconType(expanded ? 'smallicon-triangle-down' : 'smallicon-triangle-right');\n      sectionContent.classList.toggle('hidden', !expanded);\n    };\n    self.onInvokeElement(clickableElement, event => {\n      expand(sectionContent.classList.contains('hidden'));\n      event.consume();\n    });\n\n    expand(expanded);\n    this.element.appendChild(section);\n  }\n\n  /**\n   * @param {!SDK.NetworkLog.InitiatorGraph} initiatorGraph\n   * @return {!UI.TreeOutline.TreeOutlineInShadow}\n   */\n  _buildRequestChainTree(initiatorGraph) {\n    const root = new UI.TreeOutline.TreeOutlineInShadow();\n    const initiators = initiatorGraph.initiators;\n    /** @type {(!UI.TreeOutline.TreeElement|!UI.TreeOutline.TreeOutlineInShadow)} */\n    let parent = root;\n    for (const request of Array.from(initiators).reverse()) {\n      const treeElement = new UI.TreeOutline.TreeElement(request.url());\n      parent.appendChild(treeElement);\n      if (parent !== root && parent instanceof UI.TreeOutline.TreeElement) {\n        parent.expand();\n      }\n      parent = treeElement;\n    }\n\n    // The parent should be this._request tree element now.\n    if (parent instanceof UI.TreeOutline.TreeElement) {\n      parent.select();\n      const titleElement = parent.titleElement;\n      if (titleElement instanceof HTMLElement) {\n        titleElement.style.fontWeight = 'bold';\n      }\n    }\n\n    const initiated = initiatorGraph.initiated;\n    this._depthFirstSearchTreeBuilder(initiated, /** @type {!UI.TreeOutline.TreeElement} */ (parent), this._request);\n    return root;\n  }\n\n  /**\n   * @param {!Map<!SDK.NetworkRequest.NetworkRequest, !SDK.NetworkRequest.NetworkRequest>} initiated\n   * @param {!UI.TreeOutline.TreeElement} parentElement\n   * @param {!SDK.NetworkRequest.NetworkRequest} parentRequest\n   */\n  _depthFirstSearchTreeBuilder(initiated, parentElement, parentRequest) {\n    const visited = new Set();\n    // this._request should be already in the tree when build initiator part\n    visited.add(this._request);\n    for (const request of initiated.keys()) {\n      if (initiated.get(request) === parentRequest) {\n        const treeElement = new UI.TreeOutline.TreeElement(request.url());\n        parentElement.appendChild(treeElement);\n        parentElement.expand();\n        // only do dfs when we haven't done one\n        if (!visited.has(request)) {\n          visited.add(request);\n          this._depthFirstSearchTreeBuilder(initiated, treeElement, request);\n        }\n      }\n    }\n  }\n\n  /**\n   * @override\n   */\n  wasShown() {\n    if (this._hasShown) {\n      return;\n    }\n    let initiatorDataPresent = false;\n    const stackTracePreview = RequestInitiatorView.createStackTracePreview(this._request, this._linkifier, true);\n    if (stackTracePreview) {\n      initiatorDataPresent = true;\n      this._appendExpandableSection(stackTracePreview.element, ls`Request call stack`, true);\n    }\n\n    const initiatorGraph = SDK.NetworkLog.NetworkLog.instance().initiatorGraphForRequest(this._request);\n    if (initiatorGraph.initiators.size > 1 || initiatorGraph.initiated.size > 1) {\n      initiatorDataPresent = true;\n      this._appendExpandableSection(\n          this._buildRequestChainTree(initiatorGraph).element, ls`Request initiator chain`, true);\n    }\n    if (initiatorDataPresent) {\n      this._emptyWidget.hideWidget();\n    }\n    this._hasShown = true;\n  }\n}\n"]}