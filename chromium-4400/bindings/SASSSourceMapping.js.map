{"version":3,"file":"SASSSourceMapping.js","sourceRoot":"","sources":["../../../../../front_end/bindings/SASSSourceMapping.js"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2012 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Common from '../common/common.js';\nimport * as SDK from '../sdk/sdk.js';\nimport * as Workspace from '../workspace/workspace.js';\n\nimport {ContentProviderBasedProject} from './ContentProviderBasedProject.js';\nimport {CSSWorkspaceBinding, SourceMapping} from './CSSWorkspaceBinding.js';  // eslint-disable-line no-unused-vars\nimport {NetworkProject} from './NetworkProject.js';\n\n/** @type {!WeakMap<!Workspace.UISourceCode.UISourceCode, !SDK.SourceMap.TextSourceMap>} */\nconst uiSourceCodeToSourceMapMap = new WeakMap();\n\n/**\n * @implements {SourceMapping}\n */\nexport class SASSSourceMapping {\n  /**\n   * @param {!SDK.SDKModel.Target} target\n   * @param {!SDK.SourceMapManager.SourceMapManager<!SDK.CSSStyleSheetHeader.CSSStyleSheetHeader>} sourceMapManager\n   * @param {!Workspace.Workspace.WorkspaceImpl} workspace\n   */\n  constructor(target, sourceMapManager, workspace) {\n    this._sourceMapManager = sourceMapManager;\n    this._project = new ContentProviderBasedProject(\n        workspace, 'cssSourceMaps:' + target.id(), Workspace.Workspace.projectTypes.Network, '',\n        false /* isServiceProject */);\n    NetworkProject.setTargetForProject(this._project, target);\n\n    this._eventListeners = [\n      this._sourceMapManager.addEventListener(\n          SDK.SourceMapManager.Events.SourceMapAttached,\n          event => {\n            this._sourceMapAttached(event);\n          },\n          this),\n      this._sourceMapManager.addEventListener(\n          SDK.SourceMapManager.Events.SourceMapDetached,\n          event => {\n            this._sourceMapDetached(event);\n          },\n          this),\n      this._sourceMapManager.addEventListener(\n          SDK.SourceMapManager.Events.SourceMapChanged,\n          event => {\n            this._sourceMapChanged(event);\n          },\n          this)\n    ];\n  }\n\n  /**\n   * @param {?SDK.SourceMap.SourceMap} sourceMap\n   */\n  _sourceMapAttachedForTest(sourceMap) {\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  async _sourceMapAttached(event) {\n    const header = /** @type {!SDK.CSSStyleSheetHeader.CSSStyleSheetHeader} */ (event.data.client);\n    const sourceMap = /** @type {!SDK.SourceMap.TextSourceMap} */ (event.data.sourceMap);\n    for (const sassURL of sourceMap.sourceURLs()) {\n      let uiSourceCode = this._project.uiSourceCodeForURL(sassURL);\n      if (uiSourceCode) {\n        NetworkProject.addFrameAttribution(uiSourceCode, header.frameId);\n        continue;\n      }\n\n      const contentProvider =\n          sourceMap.sourceContentProvider(sassURL, Common.ResourceType.resourceTypes.SourceMapStyleSheet);\n      const mimeType =\n          Common.ResourceType.ResourceType.mimeFromURL(sassURL) || contentProvider.contentType().canonicalMimeType();\n      const embeddedContent = sourceMap.embeddedContentByURL(sassURL);\n      const metadata = typeof embeddedContent === 'string' ?\n          new Workspace.UISourceCode.UISourceCodeMetadata(null, embeddedContent.length) :\n          null;\n      uiSourceCode = this._project.createUISourceCode(sassURL, contentProvider.contentType());\n      NetworkProject.setInitialFrameAttribution(uiSourceCode, header.frameId);\n      uiSourceCodeToSourceMapMap.set(uiSourceCode, sourceMap);\n      this._project.addUISourceCodeWithProvider(uiSourceCode, contentProvider, metadata, mimeType);\n    }\n    await CSSWorkspaceBinding.instance().updateLocations(header);\n    this._sourceMapAttachedForTest(sourceMap);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  async _sourceMapDetached(event) {\n    const header = /** @type {!SDK.CSSStyleSheetHeader.CSSStyleSheetHeader} */ (event.data.client);\n    const sourceMap = /** @type {!SDK.SourceMap.SourceMap} */ (event.data.sourceMap);\n    const headers = this._sourceMapManager.clientsForSourceMap(sourceMap);\n    for (const sassURL of sourceMap.sourceURLs()) {\n      if (headers.length) {\n        const uiSourceCode = this._project.uiSourceCodeForURL(sassURL);\n        if (!uiSourceCode) {\n          continue;\n        }\n        NetworkProject.removeFrameAttribution(uiSourceCode, header.frameId);\n      } else {\n        this._project.removeFile(sassURL);\n      }\n    }\n    await CSSWorkspaceBinding.instance().updateLocations(header);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  async _sourceMapChanged(event) {\n    const sourceMap = /** @type {!SDK.SourceMap.SourceMap} */ (event.data.sourceMap);\n    const newSources = /** @type {!Map<string, string>} */ (event.data.newSources);\n    const headers = this._sourceMapManager.clientsForSourceMap(sourceMap);\n    for (const sourceURL of newSources.keys()) {\n      const uiSourceCode = this._project.uiSourceCodeForURL(sourceURL);\n      if (!uiSourceCode) {\n        console.error('Failed to update source for ' + sourceURL);\n        continue;\n      }\n      const sassText = /** @type {string} */ (newSources.get(sourceURL));\n      uiSourceCode.setWorkingCopy(sassText);\n    }\n    const updatePromises = headers.map(header => CSSWorkspaceBinding.instance().updateLocations(header));\n    await Promise.all(updatePromises);\n  }\n\n  /**\n   * @override\n   * @param {!SDK.CSSModel.CSSLocation} rawLocation\n   * @return {?Workspace.UISourceCode.UILocation}\n   */\n  rawLocationToUILocation(rawLocation) {\n    const header = rawLocation.header();\n    if (!header) {\n      return null;\n    }\n    const sourceMap = this._sourceMapManager.sourceMapForClient(header);\n    if (!sourceMap) {\n      return null;\n    }\n    const entry = sourceMap.findEntry(rawLocation.lineNumber, rawLocation.columnNumber);\n    if (!entry || !entry.sourceURL) {\n      return null;\n    }\n    const uiSourceCode = this._project.uiSourceCodeForURL(entry.sourceURL);\n    if (!uiSourceCode) {\n      return null;\n    }\n    return uiSourceCode.uiLocation(entry.sourceLineNumber || 0, entry.sourceColumnNumber);\n  }\n\n  /**\n   * @override\n   * @param {!Workspace.UISourceCode.UILocation} uiLocation\n   * @return {!Array<!SDK.CSSModel.CSSLocation>}\n   */\n  uiLocationToRawLocations(uiLocation) {\n    const sourceMap = uiSourceCodeToSourceMapMap.get(uiLocation.uiSourceCode);\n    if (!sourceMap) {\n      return [];\n    }\n    // TODO(crbug.com/1153123): Revisit the `columnNumber || 0` and also preserve `undefined` for source maps?\n    const entries = sourceMap.findReverseEntries(\n        uiLocation.uiSourceCode.url(), uiLocation.lineNumber, uiLocation.columnNumber || 0);\n    const locations = [];\n    for (const header of this._sourceMapManager.clientsForSourceMap(sourceMap)) {\n      locations.push(\n          ...entries.map(entry => new SDK.CSSModel.CSSLocation(header, entry.lineNumber, entry.columnNumber)));\n    }\n    return locations;\n  }\n\n  dispose() {\n    this._project.dispose();\n    Common.EventTarget.EventTarget.removeEventListeners(this._eventListeners);\n  }\n}\n"]}