{"version":3,"file":"WorkspaceDiff.js","sourceRoot":"","sources":["../../../../../front_end/workspace_diff/WorkspaceDiff.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2017 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport * as Diff from '../diff/diff.js';\nimport * as Host from '../host/host.js';\nimport * as Persistence from '../persistence/persistence.js';\nimport * as Workspace from '../workspace/workspace.js';\n\nexport class WorkspaceDiffImpl extends Common.ObjectWrapper.ObjectWrapper {\n  /**\n   * @param {!Workspace.Workspace.WorkspaceImpl} workspace\n   */\n  constructor(workspace) {\n    super();\n    /** @type {!WeakMap<!Workspace.UISourceCode.UISourceCode, !UISourceCodeDiff>} */\n    this._uiSourceCodeDiffs = new WeakMap();\n\n    /** @type {!Map<!Workspace.UISourceCode.UISourceCode, !Promise<?>>} */\n    this._loadingUISourceCodes = new Map();\n\n    /** @type {!Set<!Workspace.UISourceCode.UISourceCode>} */\n    this._modifiedUISourceCodes = new Set();\n    workspace.addEventListener(Workspace.Workspace.Events.WorkingCopyChanged, this._uiSourceCodeChanged, this);\n    workspace.addEventListener(Workspace.Workspace.Events.WorkingCopyCommitted, this._uiSourceCodeChanged, this);\n    workspace.addEventListener(Workspace.Workspace.Events.UISourceCodeAdded, this._uiSourceCodeAdded, this);\n    workspace.addEventListener(Workspace.Workspace.Events.UISourceCodeRemoved, this._uiSourceCodeRemoved, this);\n    workspace.addEventListener(Workspace.Workspace.Events.ProjectRemoved, this._projectRemoved, this);\n    workspace.uiSourceCodes().forEach(this._updateModifiedState.bind(this));\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {!Promise<?Diff.Diff.DiffArray>}\n   */\n  requestDiff(uiSourceCode) {\n    return this._uiSourceCodeDiff(uiSourceCode).requestDiff();\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @param {function(!Common.EventTarget.EventTargetEvent):void} callback\n   * @param {!Object=} thisObj\n   */\n  subscribeToDiffChange(uiSourceCode, callback, thisObj) {\n    this._uiSourceCodeDiff(uiSourceCode).addEventListener(Events.DiffChanged, callback, thisObj);\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @param {function(!Common.EventTarget.EventTargetEvent):void} callback\n   * @param {!Object=} thisObj\n   */\n  unsubscribeFromDiffChange(uiSourceCode, callback, thisObj) {\n    this._uiSourceCodeDiff(uiSourceCode).removeEventListener(Events.DiffChanged, callback, thisObj);\n  }\n\n  /**\n   * @return {!Array<!Workspace.UISourceCode.UISourceCode>}\n   */\n  modifiedUISourceCodes() {\n    return Array.from(this._modifiedUISourceCodes);\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {boolean}\n   */\n  isUISourceCodeModified(uiSourceCode) {\n    return this._modifiedUISourceCodes.has(uiSourceCode) || this._loadingUISourceCodes.has(uiSourceCode);\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {!UISourceCodeDiff}\n   */\n  _uiSourceCodeDiff(uiSourceCode) {\n    let diff = this._uiSourceCodeDiffs.get(uiSourceCode);\n    if (!diff) {\n      diff = new UISourceCodeDiff(uiSourceCode);\n      this._uiSourceCodeDiffs.set(uiSourceCode, diff);\n    }\n    return diff;\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _uiSourceCodeChanged(event) {\n    const uiSourceCode = /** @type {!Workspace.UISourceCode.UISourceCode} */ (event.data.uiSourceCode);\n    this._updateModifiedState(uiSourceCode);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _uiSourceCodeAdded(event) {\n    const uiSourceCode = /** @type {!Workspace.UISourceCode.UISourceCode} */ (event.data);\n    this._updateModifiedState(uiSourceCode);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _uiSourceCodeRemoved(event) {\n    const uiSourceCode = /** @type {!Workspace.UISourceCode.UISourceCode} */ (event.data);\n    this._removeUISourceCode(uiSourceCode);\n  }\n\n  /**\n   * @param {!Common.EventTarget.EventTargetEvent} event\n   */\n  _projectRemoved(event) {\n    const project = /** @type {!Workspace.Workspace.Project} */ (event.data);\n    for (const uiSourceCode of project.uiSourceCodes()) {\n      this._removeUISourceCode(uiSourceCode);\n    }\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  _removeUISourceCode(uiSourceCode) {\n    this._loadingUISourceCodes.delete(uiSourceCode);\n    const uiSourceCodeDiff = this._uiSourceCodeDiffs.get(uiSourceCode);\n    if (uiSourceCodeDiff) {\n      uiSourceCodeDiff._dispose = true;\n    }\n    this._markAsUnmodified(uiSourceCode);\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  _markAsUnmodified(uiSourceCode) {\n    this._uiSourceCodeProcessedForTest();\n    if (this._modifiedUISourceCodes.delete(uiSourceCode)) {\n      this.dispatchEventToListeners(Events.ModifiedStatusChanged, {uiSourceCode, isModified: false});\n    }\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  _markAsModified(uiSourceCode) {\n    this._uiSourceCodeProcessedForTest();\n    if (this._modifiedUISourceCodes.has(uiSourceCode)) {\n      return;\n    }\n    this._modifiedUISourceCodes.add(uiSourceCode);\n    this.dispatchEventToListeners(Events.ModifiedStatusChanged, {uiSourceCode, isModified: true});\n  }\n\n  _uiSourceCodeProcessedForTest() {\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  async _updateModifiedState(uiSourceCode) {\n    this._loadingUISourceCodes.delete(uiSourceCode);\n\n    if (uiSourceCode.project().type() !== Workspace.Workspace.projectTypes.Network) {\n      this._markAsUnmodified(uiSourceCode);\n      return;\n    }\n    if (uiSourceCode.isDirty()) {\n      this._markAsModified(uiSourceCode);\n      return;\n    }\n    if (!uiSourceCode.hasCommits()) {\n      this._markAsUnmodified(uiSourceCode);\n      return;\n    }\n\n    const contentsPromise = Promise.all([\n      this.requestOriginalContentForUISourceCode(uiSourceCode),\n      uiSourceCode.requestContent().then(deferredContent => deferredContent.content)\n    ]);\n\n    this._loadingUISourceCodes.set(uiSourceCode, contentsPromise);\n    const contents = await contentsPromise;\n    if (this._loadingUISourceCodes.get(uiSourceCode) !== contentsPromise) {\n      return;\n    }\n    this._loadingUISourceCodes.delete(uiSourceCode);\n\n    if (contents[0] !== null && contents[1] !== null && contents[0] !== contents[1]) {\n      this._markAsModified(uiSourceCode);\n    } else {\n      this._markAsUnmodified(uiSourceCode);\n    }\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {!Promise<?string>}\n   */\n  requestOriginalContentForUISourceCode(uiSourceCode) {\n    return this._uiSourceCodeDiff(uiSourceCode)._originalContent();\n  }\n\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   * @return {!Promise<void>}\n   */\n  revertToOriginal(uiSourceCode) {\n    /**\n     * @param {?string} content\n     */\n    function callback(content) {\n      if (typeof content !== 'string') {\n        return;\n      }\n\n      uiSourceCode.addRevision(content);\n    }\n\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.RevisionApplied);\n    return this.requestOriginalContentForUISourceCode(uiSourceCode).then(callback);\n  }\n}\n\nexport class UISourceCodeDiff extends Common.ObjectWrapper.ObjectWrapper {\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  constructor(uiSourceCode) {\n    super();\n    this._uiSourceCode = uiSourceCode;\n    uiSourceCode.addEventListener(Workspace.UISourceCode.Events.WorkingCopyChanged, this._uiSourceCodeChanged, this);\n    uiSourceCode.addEventListener(Workspace.UISourceCode.Events.WorkingCopyCommitted, this._uiSourceCodeChanged, this);\n    this._requestDiffPromise = null;\n    this._pendingChanges = null;\n    this._dispose = false;\n  }\n\n  _uiSourceCodeChanged() {\n    if (this._pendingChanges) {\n      clearTimeout(this._pendingChanges);\n      this._pendingChanges = null;\n    }\n    this._requestDiffPromise = null;\n\n    const content = this._uiSourceCode.content();\n    const delay = (!content || content.length < 65536) ? 0 : UpdateTimeout;\n    this._pendingChanges = setTimeout(emitDiffChanged.bind(this), delay);\n\n    /**\n     * @this {UISourceCodeDiff}\n     */\n    function emitDiffChanged() {\n      if (this._dispose) {\n        return;\n      }\n      this.dispatchEventToListeners(Events.DiffChanged);\n      this._pendingChanges = null;\n    }\n  }\n\n  /**\n   * @return {!Promise<?Diff.Diff.DiffArray>}\n   */\n  requestDiff() {\n    if (!this._requestDiffPromise) {\n      this._requestDiffPromise = this._innerRequestDiff();\n    }\n    return this._requestDiffPromise;\n  }\n\n  /**\n   * @return {!Promise<?string>}\n   */\n  async _originalContent() {\n    const originalNetworkContent =\n        Persistence.NetworkPersistenceManager.NetworkPersistenceManager.instance().originalContentForUISourceCode(\n            this._uiSourceCode);\n    if (originalNetworkContent) {\n      return originalNetworkContent;\n    }\n\n    const content = await this._uiSourceCode.project().requestFileContent(this._uiSourceCode);\n    return content.content || ('error' in content && content.error) || '';\n  }\n\n  /**\n   * @return {!Promise<?Diff.Diff.DiffArray>}\n   */\n  async _innerRequestDiff() {\n    if (this._dispose) {\n      return null;\n    }\n\n    const baseline = await this._originalContent();\n    if (baseline === null) {\n      return null;\n    }\n    if (baseline.length > 1024 * 1024) {\n      return null;\n    }\n    // ------------ ASYNC ------------\n    if (this._dispose) {\n      return null;\n    }\n\n    let current = this._uiSourceCode.workingCopy();\n    if (!current && !this._uiSourceCode.contentLoaded()) {\n      current = /** @type {string} */ ((await this._uiSourceCode.requestContent()).content);\n    }\n\n    if (current.length > 1024 * 1024) {\n      return null;\n    }\n\n    if (this._dispose) {\n      return null;\n    }\n\n    if (current === null || baseline === null) {\n      return null;\n    }\n    return Diff.Diff.DiffWrapper.lineDiff(baseline.split(/\\r\\n|\\n|\\r/), current.split(/\\r\\n|\\n|\\r/));\n  }\n}\n\n/**\n * @enum {symbol}\n */\nexport const Events = {\n  DiffChanged: Symbol('DiffChanged'),\n  ModifiedStatusChanged: Symbol('ModifiedStatusChanged')\n};\n\n/** @type {?WorkspaceDiffImpl} */\nlet _instance = null;\n\n/**\n * @return {!WorkspaceDiffImpl}\n */\nexport function workspaceDiff() {\n  if (!_instance) {\n    _instance = new WorkspaceDiffImpl(Workspace.Workspace.WorkspaceImpl.instance());\n  }\n  return _instance;\n}\n\nexport class DiffUILocation {\n  /**\n   * @param {!Workspace.UISourceCode.UISourceCode} uiSourceCode\n   */\n  constructor(uiSourceCode) {\n    this.uiSourceCode = uiSourceCode;\n  }\n}\n\nexport const UpdateTimeout = 200;\n"]}