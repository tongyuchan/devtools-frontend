{"version":3,"file":"AccessibilityModel.js","sourceRoot":"","sources":["../../../../../front_end/sdk/AccessibilityModel.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {DeferredDOMNode, DOMModel, DOMNode} from './DOMModel.js';           // eslint-disable-line no-unused-vars\nimport {Capability, SDKModel, Target, TargetManager} from './SDKModel.js';  // eslint-disable-line no-unused-vars\n\n/** @enum {string} */\nexport const CoreAxPropertyName = {\n  Name: 'name',\n  Description: 'description',\n  Value: 'value',\n  Role: 'role',\n};\n\n/** @typedef {{\n *   name: (CoreAxPropertyName | Protocol.Accessibility.AXPropertyName),\n *   value: Protocol.Accessibility.AXValue\n * }}\n */\n// @ts-ignore typedef\nexport let CoreOrProtocolAxProperty;\n\nexport class AccessibilityNode {\n  /**\n   * @param {!AccessibilityModel} accessibilityModel\n   * @param {!Protocol.Accessibility.AXNode} payload\n   */\n  constructor(accessibilityModel, payload) {\n    this._accessibilityModel = accessibilityModel;\n    this._agent = accessibilityModel._agent;\n\n    this._id = payload.nodeId;\n    accessibilityModel._setAXNodeForAXId(this._id, this);\n    if (payload.backendDOMNodeId) {\n      accessibilityModel._setAXNodeForBackendDOMNodeId(payload.backendDOMNodeId, this);\n      this._backendDOMNodeId = payload.backendDOMNodeId;\n      this._deferredDOMNode = new DeferredDOMNode(accessibilityModel.target(), payload.backendDOMNodeId);\n    } else {\n      this._backendDOMNodeId = null;\n      this._deferredDOMNode = null;\n    }\n    this._ignored = payload.ignored;\n    if (this._ignored && 'ignoredReasons' in payload) {\n      this._ignoredReasons = payload.ignoredReasons;\n    }\n\n    this._role = payload.role || null;\n    this._name = payload.name || null;\n    this._description = payload.description || null;\n    this._value = payload.value || null;\n    this._properties = payload.properties || null;\n    this._childIds = payload.childIds || null;\n    this._parentNode = null;\n  }\n\n  /**\n   * @return {!AccessibilityModel}\n   */\n  accessibilityModel() {\n    return this._accessibilityModel;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  ignored() {\n    return this._ignored;\n  }\n\n  /**\n   * @return {?Array<!Protocol.Accessibility.AXProperty>}\n   */\n  ignoredReasons() {\n    return this._ignoredReasons || null;\n  }\n\n  /**\n   * @return {?Protocol.Accessibility.AXValue}\n   */\n  role() {\n    return this._role || null;\n  }\n\n  /**\n   * @return {!Array<!CoreOrProtocolAxProperty>}\n   */\n  coreProperties() {\n    /** @type {!Array<!CoreOrProtocolAxProperty>} */\n    const properties = [];\n\n    if (this._name) {\n      properties.push({name: CoreAxPropertyName.Name, value: this._name});\n    }\n    if (this._description) {\n      properties.push({name: CoreAxPropertyName.Description, value: this._description});\n    }\n    if (this._value) {\n      properties.push({name: CoreAxPropertyName.Value, value: this._value});\n    }\n\n    return properties;\n  }\n\n  /**\n   * @return {?Protocol.Accessibility.AXValue}\n   */\n  name() {\n    return this._name || null;\n  }\n\n  /**\n   * @return {?Protocol.Accessibility.AXValue}\n   */\n  description() {\n    return this._description || null;\n  }\n\n  /**\n   * @return {?Protocol.Accessibility.AXValue}\n   */\n  value() {\n    return this._value || null;\n  }\n\n  /**\n   * @return {?Array<!Protocol.Accessibility.AXProperty>}\n   */\n  properties() {\n    return this._properties || null;\n  }\n\n  /**\n   * @return {?AccessibilityNode}\n   */\n  parentNode() {\n    return this._parentNode;\n  }\n\n  /**\n   * @param {?AccessibilityNode} parentNode\n   */\n  _setParentNode(parentNode) {\n    this._parentNode = parentNode;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isDOMNode() {\n    return Boolean(this._backendDOMNodeId);\n  }\n\n  /**\n   * @return {?number}\n   */\n  backendDOMNodeId() {\n    return this._backendDOMNodeId;\n  }\n\n  /**\n   * @return {?DeferredDOMNode}\n   */\n  deferredDOMNode() {\n    return this._deferredDOMNode;\n  }\n\n  highlightDOMNode() {\n    const deferredNode = this.deferredDOMNode();\n    if (!deferredNode) {\n      return;\n    }\n    // Highlight node in page.\n    deferredNode.highlight();\n  }\n\n  /**\n   * @return {!Array<!AccessibilityNode>}\n   */\n  children() {\n    if (!this._childIds) {\n      return [];\n    }\n\n    const children = [];\n    for (const childId of this._childIds) {\n      const child = this._accessibilityModel.axNodeForId(childId);\n      if (child) {\n        children.push(child);\n      }\n    }\n\n    return children;\n  }\n\n  /**\n   * @return {number}\n   */\n  numChildren() {\n    if (!this._childIds) {\n      return 0;\n    }\n    return this._childIds.length;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  hasOnlyUnloadedChildren() {\n    if (!this._childIds || !this._childIds.length) {\n      return false;\n    }\n\n    return !this._childIds.some(id => this._accessibilityModel.axNodeForId(id) !== null);\n  }\n}\n\nexport class AccessibilityModel extends SDKModel {\n  /**\n   * @param {!Target} target\n   */\n  constructor(target) {\n    super(target);\n    this._agent = target.accessibilityAgent();\n\n    /** @type {!Map<string, !AccessibilityNode>} */\n    this._axIdToAXNode = new Map();\n    this._backendDOMNodeIdToAXNode = new Map();\n  }\n\n  clear() {\n    this._axIdToAXNode.clear();\n  }\n\n  /**\n   * @param {!DOMNode} node\n   * @return {!Promise<void>}\n   */\n  async requestPartialAXTree(node) {\n    const {nodes} = await this._agent.invoke_getPartialAXTree(\n        {nodeId: node.id, backendNodeId: undefined, objectId: undefined, fetchRelatives: true});\n    if (!nodes) {\n      return;\n    }\n\n    for (const payload of nodes) {\n      new AccessibilityNode(this, payload);\n    }\n\n    for (const axNode of this._axIdToAXNode.values()) {\n      for (const axChild of axNode.children()) {\n        axChild._setParentNode(axNode);\n      }\n    }\n  }\n\n  /**\n   * @param {number} depth\n   * @return ?{!Promise<AccessibilityNode>}\n   */\n  async requestRootNode(depth = 2) {\n    const {nodes} = await this._agent.invoke_getFullAXTree({max_depth: depth});\n    if (!nodes) {\n      return;\n    }\n\n    const axNodes = nodes.map(node => new AccessibilityNode(this, node));\n\n    for (const axNode of this._axIdToAXNode.values()) {\n      for (const axChild of axNode.children()) {\n        axChild._setParentNode(axNode);\n      }\n    }\n    return axNodes[0];\n  }\n\n  /**\n   * @param {string} axId\n   * @return {?AccessibilityNode}\n   */\n  axNodeForId(axId) {\n    return this._axIdToAXNode.get(axId) || null;\n  }\n\n  /**\n   * @param {string} axId\n   * @param {!AccessibilityNode} axNode\n   */\n  _setAXNodeForAXId(axId, axNode) {\n    this._axIdToAXNode.set(axId, axNode);\n  }\n\n  /**\n   * @param {?DOMNode} domNode\n   * @return {?AccessibilityNode}\n   */\n  axNodeForDOMNode(domNode) {\n    if (!domNode) {\n      return null;\n    }\n    return this._backendDOMNodeIdToAXNode.get(domNode.backendNodeId());\n  }\n\n  /**\n   * @param {number} backendDOMNodeId\n   * @param {!AccessibilityNode} axNode\n   */\n  _setAXNodeForBackendDOMNodeId(backendDOMNodeId, axNode) {\n    this._backendDOMNodeIdToAXNode.set(backendDOMNodeId, axNode);\n  }\n}\n\nSDKModel.register(AccessibilityModel, Capability.DOM, false);\n"]}