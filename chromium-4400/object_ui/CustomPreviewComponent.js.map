{"version":3,"file":"CustomPreviewComponent.js","sourceRoot":"","sources":["../../../../../front_end/object_ui/CustomPreviewComponent.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport * as SDK from '../sdk/sdk.js';  // eslint-disable-line no-unused-vars\nimport * as UI from '../ui/ui.js';\n\nimport {ObjectPropertiesSection} from './ObjectPropertiesSection.js';\n\nexport class CustomPreviewSection {\n  /**\n   * @param {!SDK.RemoteObject.RemoteObject} object\n   */\n  constructor(object) {\n    this._sectionElement = document.createElement('span');\n    this._sectionElement.classList.add('custom-expandable-section');\n    this._object = object;\n    this._expanded = false;\n    /**\n     * @type {?Node}\n     */\n    this._cachedContent = null;\n    const customPreview = object.customPreview();\n\n    if (!customPreview) {\n      return;\n    }\n\n    let headerJSON;\n    try {\n      headerJSON = JSON.parse(customPreview.header);\n    } catch (e) {\n      Common.Console.Console.instance().error('Broken formatter: header is invalid json ' + e);\n      return;\n    }\n    this._header = this._renderJSONMLTag(headerJSON);\n    if (this._header.nodeType === Node.TEXT_NODE) {\n      Common.Console.Console.instance().error('Broken formatter: header should be an element node.');\n      return;\n    }\n\n    if (customPreview.bodyGetterId) {\n      if (this._header instanceof Element) {\n        this._header.classList.add('custom-expandable-section-header');\n      }\n      this._header.addEventListener('click', this._onClick.bind(this), false);\n      this._expandIcon = UI.Icon.Icon.create('smallicon-triangle-right', 'custom-expand-icon');\n      this._header.insertBefore(this._expandIcon, this._header.firstChild);\n    }\n\n    this._sectionElement.appendChild(this._header);\n  }\n\n  /**\n   * @return {!Element}\n   */\n  element() {\n    return this._sectionElement;\n  }\n\n  /**\n   * @param {*} jsonML\n   * @return {!Node}\n   */\n  _renderJSONMLTag(jsonML) {\n    if (!Array.isArray(jsonML)) {\n      return document.createTextNode(String(jsonML));\n    }\n\n    const array = /** @type {!Array.<*>} */ (jsonML);\n    return array[0] === 'object' ? this._layoutObjectTag(array) : this._renderElement(array);\n  }\n\n  /**\n   *\n   * @param {!Array.<*>} object\n   * @return {!Node}\n   */\n  _renderElement(object) {\n    const tagName = object.shift();\n    if (!CustomPreviewSection._allowedTags.has(tagName)) {\n      Common.Console.Console.instance().error('Broken formatter: element ' + tagName + ' is not allowed!');\n      return document.createElement('span');\n    }\n    const element = document.createElement(/** @type {string} */ (tagName));\n    if ((typeof object[0] === 'object') && !Array.isArray(object[0])) {\n      const attributes = object.shift();\n      for (const key in attributes) {\n        const value = attributes[key];\n        if ((key !== 'style') || (typeof value !== 'string')) {\n          continue;\n        }\n\n        element.setAttribute(key, value);\n      }\n    }\n\n    this._appendJsonMLTags(element, object);\n    return element;\n  }\n\n  /**\n   * @param {!Array.<*>} objectTag\n   * @return {!Node}\n   */\n  _layoutObjectTag(objectTag) {\n    objectTag.shift();\n    const attributes = objectTag.shift();\n    const remoteObject = this._object.runtimeModel().createRemoteObject(\n        /** @type {!Protocol.Runtime.RemoteObject} */ (attributes));\n    if (remoteObject.customPreview()) {\n      return (new CustomPreviewSection(remoteObject)).element();\n    }\n\n    const sectionElement = ObjectPropertiesSection.defaultObjectPresentation(remoteObject);\n    sectionElement.classList.toggle('custom-expandable-section-standard-section', remoteObject.hasChildren);\n    return sectionElement;\n  }\n\n  /**\n   * @param {!Node} parentElement\n   * @param {!Array.<*>} jsonMLTags\n   */\n  _appendJsonMLTags(parentElement, jsonMLTags) {\n    for (let i = 0; i < jsonMLTags.length; ++i) {\n      parentElement.appendChild(this._renderJSONMLTag(jsonMLTags[i]));\n    }\n  }\n\n  /**\n   * @param {!Event} event\n   */\n  _onClick(event) {\n    event.consume(true);\n    if (this._cachedContent) {\n      this._toggleExpand();\n    } else {\n      this._loadBody();\n    }\n  }\n\n  _toggleExpand() {\n    this._expanded = !this._expanded;\n    if (this._header instanceof Element) {\n      this._header.classList.toggle('expanded', this._expanded);\n    }\n    if (this._cachedContent instanceof Element) {\n      this._cachedContent.classList.toggle('hidden', !this._expanded);\n    }\n    if (this._expandIcon) {\n      if (this._expanded) {\n        this._expandIcon.setIconType('smallicon-triangle-down');\n      } else {\n        this._expandIcon.setIconType('smallicon-triangle-right');\n      }\n    }\n  }\n\n  async _loadBody() {\n    const customPreview = this._object.customPreview();\n\n    if (!customPreview) {\n      return;\n    }\n\n    if (customPreview.bodyGetterId) {\n      const bodyJsonML = await this._object.callFunctionJSON(\n          bodyGetter => /** @type {function():*} */ (bodyGetter)(), [{objectId: customPreview.bodyGetterId}]);\n      if (!bodyJsonML) {\n        return;\n      }\n\n      this._cachedContent = this._renderJSONMLTag(bodyJsonML);\n      this._sectionElement.appendChild(this._cachedContent);\n      this._toggleExpand();\n    }\n  }\n}\n\nexport class CustomPreviewComponent {\n  /**\n   * @param {!SDK.RemoteObject.RemoteObject} object\n   */\n  constructor(object) {\n    this._object = object;\n    /** @type {?CustomPreviewSection} */\n    this._customPreviewSection = new CustomPreviewSection(object);\n    this.element = document.createElement('span');\n    this.element.classList.add('source-code');\n    const shadowRoot = UI.Utils.createShadowRootWithCoreStyles(\n        this.element,\n        {cssFile: 'object_ui/customPreviewComponent.css', enableLegacyPatching: false, delegatesFocus: undefined});\n    this.element.addEventListener('contextmenu', this._contextMenuEventFired.bind(this), false);\n    shadowRoot.appendChild(this._customPreviewSection.element());\n  }\n\n  expandIfPossible() {\n    const customPreview = this._object.customPreview();\n    if (customPreview && customPreview.bodyGetterId && this._customPreviewSection) {\n      this._customPreviewSection._loadBody();\n    }\n  }\n\n  /**\n   * @param {!Event} event\n   */\n  _contextMenuEventFired(event) {\n    const contextMenu = new UI.ContextMenu.ContextMenu(event);\n    if (this._customPreviewSection) {\n      contextMenu.revealSection().appendItem(\n          Common.UIString.UIString('Show as JavaScript object'), this._disassemble.bind(this));\n    }\n    contextMenu.appendApplicableItems(this._object);\n    contextMenu.show();\n  }\n\n  _disassemble() {\n    if (this.element.shadowRoot) {\n      this.element.shadowRoot.textContent = '';\n      this._customPreviewSection = null;\n      this.element.shadowRoot.appendChild(ObjectPropertiesSection.defaultObjectPresentation(this._object));\n    }\n  }\n}\n\nCustomPreviewSection._allowedTags = new Set(['span', 'div', 'ol', 'li', 'table', 'tr', 'td']);\n"]}